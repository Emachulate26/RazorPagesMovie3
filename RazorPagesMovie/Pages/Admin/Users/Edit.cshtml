@page
@model EditModel
@{
    ViewData["Title"] = "Edit User Roles";
}

<h1>Edit Roles for User: @Model.User.UserName</h1>
<hr />

<div class="row">
    <div class="col-md-6">
        <form method="post">

            @* The hidden input MUST be an asp-for bound to a property to ensure the entire model is posted back. *@
            <input type="hidden" asp-for="@Model.UserId" />

            <h2>Assign Roles</h2>

            @for (int i = 0; i < Model.RoleList.Count; i++)
            {
                <div class="form-check">

                    @* CRITICAL FIX 1: Add asp-for for the index to guide the model binder *@
                    <input type="hidden" asp-for="@Model.RoleList[i].RoleName" />

                    @* CRITICAL FIX 2: Ensure the RoleName is sent for every role, checked or not *@
                    <input type="hidden" asp-for="@Model.RoleList[i].RoleName" />

                    @* The checkbox handles the IsSelected property *@
                    <input class="form-check-input" type="checkbox" asp-for="@Model.RoleList[i].IsSelected" />

                    <label class="form-check-label" asp-for="@Model.RoleList[i].IsSelected">
                        @Model.RoleList[i].RoleName
                    </label>
                </div>
            }

            <div class="form-group mt-4">
                <input type="submit" value="Save Roles" class="btn btn-primary" />
                <a asp-page="./Index" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>n